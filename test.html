<!doctype html>
<html>
    <head>
        <script src="logger.js"></script>
        <script src="iml.js"></script>
        <script src="api.js"></script>
        <style>
            #editor {
                position: absolute;
                top:      8px;
                left:     8px;
                right:    8px;
                height:   400px;
            }

            #output {
                position: absolute;
                top:      422px;
                left:     8px;
                right:    8px;
                bottom:   8px;

                font-family: monospace;

                padding: 8px;

                background-color: #dddddd;
            }
        </style>
    </head>
    <body>
        <textarea id="editor">&lt;?xml version="1.0"?&gt;</textarea>
        <div id="output"></div>
    </body>
    <script>
        var editor = document.getElementById('editor');
        var logger = new Logger(document.getElementById('output'));

        var handleChange = function(forceReload) {
            if (editor.value === localStorage.editorContents && !forceReload) {
                return;
            }
            localStorage.editorContents = editor.value;

            var scrollAnchor = logger.scrollAnchor();
            logger.clear();

            var parser = new DOMParser();
            var doc = parser.parseFromString(editor.value,
                                             'application/xml');
            if (!doc.childNodes.length) {
                logger.error('Failed to parse');
                return;
            }

            try {
                // Top level errors are contained within doc.body; all other
                // errors are contained within the particular node. To
                // gracefully handle this inside the instantiator, the ugly
                // check is performed here.
                IML.instantiate((doc.body ? doc.body : doc).firstChild,
                                API.meta(logger.log.bind(logger)));
            }
            catch (e) {
                logger.error(e);
            }

            logger.scroll(scrollAnchor);
        };

        document.body.onload = function() {
            editor.value = localStorage.editorContents ||
                           ('<?xml version=\'1.0\'?>\n'                       +
                            '<Container property=\'foo\'>\n'                  +
                            '  <Child/>\n'                                    +
                            '</Container>\n');
            handleChange(true);
        };

        editor.onkeyup  = function() { handleChange(); };
        editor.onchange = function() { handleChange(); };
    </script>
</html>

