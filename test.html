<!doctype html>
<html>
    <head>
        <script src="iml.js"></script>
        <script src="api.js"></script>
        <style>
            #editor {
                position: absolute;
                top:      8px;
                left:     8px;
                right:    8px;
                height:   400px;
            }

            #output {
                position: absolute;
                top:      422px;
                left:     8px;
                right:    8px;
                bottom:   8px;

                overflow-y: scroll;

                font-family: monospace;

                padding: 8px;

                background-color: #dddddd;
            }
        </style>
    </head>
    <body>
        <textarea id="editor">&lt;?xml version="1.0"?&gt;</textarea>
        <div id="output"></div>
    </body>
    <script>
        var editor = document.getElementById("editor");
        var output = document.getElementById("output");

        var handleChange = function() {
            localStorage.editorContents = editor.value;

            var scrolledToBottom = output.scrollHeight === (
                                        output.scrollTop + output.offsetHeight);

            output.innerHTML = "";
            var logEntry = 0;
            function log(text, is_error) {
                var item = document.createElement("span");
                item.innerText = (logEntry++) + ": " + text;
                if (is_error) {
                    item.style.color = "red";
                }
                output.appendChild(item);
                output.appendChild(document.createElement("br"));
            }

            var parser = new DOMParser();
            var doc = parser.parseFromString(editor.value,
                                             "application/xml");
            try {
                // Top level errors are contained within doc.body; all other
                // errors are contained within the particular node. To
                // gracefully handle this inside the instantiator, the ugly
                // check is performed here.
                IML.instantiate((doc.body ? doc.body : doc).firstChild,
                                API.meta(log));
            }
            catch (e) {
                log(e, true);
            }

            if (scrolledToBottom) {
                output.scrollTop = output.scrollHeight;
            }
        };

        document.body.onload = function() {
            editor.value = localStorage.editorContents ||
                           '<?xml version="1.0"?>\n';
            handleChange();
        };

        editor.onkeyup  = handleChange;
        editor.onchange = handleChange;
    </script>
</html>

